angular.module('starter').controller('VirtualLoyaltyCardViewController',function($cordovaBarcodeScanner,$ocLazyLoad,$cordovaClipboard,$ionicHistory,$scope,$timeout,$translate,$window,Dialog,$stateParams,$location,$sce,$state,Application,VirtualLoyaltyCard,Customer){$scope.$on('connectionStateChange',function(event,args){if(args.isOnline===!0){$scope.loadContent()}});VirtualLoyaltyCard.value_id=$stateParams.value_id;$scope.pageTitle='';$scope.scan_protocols=['tel:','http:','https:','geo:','smsto:','mailto:','ctc:'];$scope.formats={'CODE_39':'code39','CODE_128':'code128','EAN_13':'ean13','EAN_8':'ean8','UPC_A':'upca'};$scope.is_protocol_found=!1;$scope.is_loading=!0;$scope.has_card=!1;$scope.is_logged_in=Customer.isLoggedIn();$scope.qrCode='';$scope.qrDatetime='';$scope.is_scanner_opened=!1;$scope.bcid=(localStorage.getItem('ls_bcid')!==null)?localStorage.getItem('ls_bcid'):$scope.formats.CODE_128;$scope.createDatetime=function(){localStorage.setItem('ls_datetime',moment.now())};$scope.loadContent=function(){var current=moment.now();if(typeof Storage!=='undefined'){if(localStorage.getItem('ls_code')!==null){$scope.qrCode=localStorage.getItem('ls_code');$scope.qrDatetime=moment(localStorage.getItem('ls_datetime')).format('lll');current=localStorage.getItem('ls_datetime')}}
VirtualLoyaltyCard.find($scope.qrCode,current).then(function(data){if(moment(data.virtualLoyaltycardData.qrDatetime).isValid()){$scope.qrDatetime=moment(data.virtualLoyaltycardData.qrDatetime).format('lll');current=data.virtualLoyaltycardData.qrDatetime}else{$scope.qrDatetime=moment(moment.now()).format('lll')}
$scope.qrCode=data.virtualLoyaltycardData.qrCode;localStorage.setItem('ls_code',$scope.qrCode);localStorage.setItem('ls_datetime',current);if($scope.qrCode.length===12&&$scope.bcid==='ean13'){$scope.qrCode='0'+$scope.qrCode;localStorage.setItem('ls_code',$scope.qrCode)}
$scope.pageTitle=data.pageTitle;$scope.has_card=!0}).then(function(){$scope.is_loading=!1})};$scope.openScanner=function(){$cordovaBarcodeScanner.scan().then(function(barcodeData){if(!barcodeData.cancelled&&barcodeData.text!==''&&!$scope.is_scanner_opened){$scope.is_scanner_opened=!0;$timeout(function(){for(var i=0;i<$scope.scan_protocols.length;i++){var bcdata=barcodeData.text;if(barcodeData.text.toLowerCase().indexOf($scope.scan_protocols[i])===0){if($scope.scan_protocols[i]==='http:'||$scope.scan_protocols[i]==='https:'){$window.open(barcodeData.text,'_blank','location=yes')}else{var content_url=barcodeData.text;if($scope.scan_protocols[i]==='smsto:'&&ionic.Platform.isIOS()){content_url=content_url.replace(/(smsto|SMSTO):/,'sms:').replace(/([0-9]):(.*)/,'$1')}else if($scope.scan_protocols[i]==='geo:'&&ionic.Platform.isIOS()){content_url=content_url.replace(/(geo|GEO):/,'https://maps.apple.com/?q=')}
$window.open(content_url,'_blank','location=no')}
if(barcodeData.format in $scope.formats){$scope.bcid=$scope.formats[barcodeData.format];if(barcodeData.format==='EAN_13'&&bcdata.length===12){bcdata='0'+bcdata}}else{$scope.bcid=$scope.formats.CODE_128}
localStorage.setItem('ls_bcid',$scope.bcid);localStorage.setItem('ls_code',bcdata);$scope.createDatetime();$scope.has_card=!0;$scope.is_protocol_found=!0;$scope.is_scanner_opened=!1;$state.go($state.current,{},{reload:!0});break}else if($scope.scan_protocols[i]==='ctc:'){var buttons=['OK'];Dialog.confirm('Scan result',barcodeData.text,buttons,'text-center').then(function(res){if(barcodeData.format in $scope.formats){$scope.bcid=$scope.formats[barcodeData.format];if(barcodeData.format==='EAN_13'&&bcdata.length===12){bcdata='0'+bcdata}}else{$scope.bcid=$scope.formats.CODE_128}
localStorage.setItem('ls_bcid',$scope.bcid);localStorage.setItem('ls_code',bcdata);$scope.createDatetime();$scope.has_card=!0;$scope.is_scanner_opened=!1;$scope.is_protocol_found=!0;$state.go($state.current,{},{reload:!0})});break}}
if(!$scope.is_protocol_found){Dialog.alert('Scan result',barcodeData.text,'OK');$scope.is_scanner_opened=!1}})}},function(error){Dialog.alert('Error','An error occurred while reading the code.','OK');$scope.is_scanner_opened=!1})};$ocLazyLoad.load('./dist/lazy/moment.min.js').then(function(){$scope.loadContent()})});angular.module('starter').factory('VirtualLoyaltyCard',function($pwaRequest){var factory={value_id:null};factory.find=function(qrCode,qrDatetime){if(!this.value_id){return $pwaRequest.reject('[VirtualLoyaltyCard::find] Missing value_id!')}
return $pwaRequest.get('virtualloyaltycard/mobile_view/find',{urlParams:{value_id:this.value_id,qrCode:qrCode,qrDatetime:qrDatetime}})};return factory});Features.insertCSS("","virtualloyaltycard")